# MessageForwarder ‚Äî MTProto (Telethon) + Bot API (aiogram)

–§–æ—Ä–≤–∞—Ä–¥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π **—á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö/—Ç–æ–ø–∏–∫–∞—Ö —á–µ—Ä–µ–∑ MTProto (–∫–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)** –∏ **–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ Bot API** –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —á–∞—Ç—ã.

–ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞, –∑–∞—á–µ–º MTProto: **Bot API-–±–æ—Ç –Ω–µ –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –±–æ—Ç–æ–≤**, –∞ MTProto ‚Äî –≤–∏–¥–∏—Ç.

- ‚úÖ –ß–∏—Ç–∞–µ—Ç **–ª—é–¥–µ–π / –±–æ—Ç–æ–≤ / sender_chat** —á–µ—Ä–µ–∑ Telethon
- ‚úÖ –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ **–≥—Ä—É–ø–ø–µ + —Ç–æ–ø–∏–∫—É (thread/topic)** —á–µ—Ä–µ–∑ `routes.yaml`
- ‚úÖ –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤ **–ª–∏—á–∫—É/–≥—Ä—É–ø–ø—ã/—Ç–æ–ø–∏–∫–∏** —á–µ—Ä–µ–∑ aiogram
- ‚úÖ MTProto –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å, —á—Ç–æ–±—ã –æ–Ω **—Å–ª—É—à–∞–ª —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —á–∞—Ç—ã** —á–µ—Ä–µ–∑ env `MT_ALLOWED_CHAT_IDS`
- ‚úÖ –ï—Å–ª–∏ `forward_message` –Ω–µ –º–æ–∂–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥–Ω—É—Ç—å (—á–∞—Å—Ç–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥—Ä—É–≥–∏—Ö –±–æ—Ç–æ–≤) ‚Äî –≤–∫–ª—é—á–∞–µ–º **fallback ‚Äúrepost‚Äù** (—Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)

---

## 1) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.12+ (–∏–ª–∏ Docker)
- Telegram –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è MTProto)
- Telegram –±–æ—Ç (BotFather)
- Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## 2) –ü–æ–ª—É—á–∞–µ–º TG_API_ID / TG_API_HASH (Telegram App –¥–ª—è MTProto)

–≠—Ç–æ **–Ω–µ BotFather**.

1. –û—Ç–∫—Ä–æ–π `https://my.telegram.org`
2. –í–æ–π–¥–∏ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–æ–¥ –ø—Ä–∏–¥—ë—Ç –≤ Telegram)
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **API development tools**
4. –°–æ–∑–¥–∞–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ª—é–±—ã–µ –Ω–∞–∑–≤–∞–Ω–∏–µ/short name)
5. –°–æ—Ö—Ä–∞–Ω–∏:

   - `api_id` ‚Üí `TG_API_ID`
   - `api_hash` ‚Üí `TG_API_HASH`

---

## 3) –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞ (BotFather)

1. –û—Ç–∫—Ä–æ–π `@BotFather`
2. `/newbot`
3. –ü–æ–ª—É—á–∏ —Ç–æ–∫–µ–Ω ‚Üí `BOT_TOKEN`

---

## 4) –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º MTProto —Å–µ—Å—Å–∏—é (StringSession)

–°–µ—Å—Å–∏—é –≥–µ–Ω–µ—Ä–∏–º **–æ–¥–∏–Ω —Ä–∞–∑ –ª–æ–∫–∞–ª—å–Ω–æ** (–Ω–µ –≤ Docker), —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ –∫–æ–¥/2FA.

–£—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
pip install telethon
```

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è:

```bash
python scripts/make_session.py
```

–°–∫—Ä–∏–ø—Ç —Å–ø—Ä–æ—Å–∏—Ç:

- `TG_API_ID`
- `TG_API_HASH`
- `PHONE` (+7..., +372..., etc)

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ —Ä–∞—Å–ø–µ—á–∞—Ç–∞–µ—Ç:

```
=== TG_USER_SESSION ===
1AABCD....(–¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)
=======================
```

–≠—Ç–æ `TG_USER_SESSION`.

‚ö†Ô∏è –≠—Ç–æ —Å–µ–∫—Ä–µ—Ç —É—Ä–æ–≤–Ω—è ‚Äú–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É‚Äù.

---

## 5) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º `.env`

–°–æ–∑–¥–∞–π `.env` –≤ –∫–æ—Ä–Ω–µ (—Ä—è–¥–æ–º —Å `docker-compose.yml`).

–ü—Ä–∏–º–µ—Ä:

```env
BOT_TOKEN=123456:ABCDEF...

TG_API_ID=123456
TG_API_HASH=abcdef0123456789abcdef0123456789
TG_USER_SESSION=1AABCD...–æ—á–µ–Ω—å_–¥–ª–∏–Ω–Ω–∞—è_—Å—Ç—Ä–æ–∫–∞...

# –ö–æ–Ω—Ñ–∏–≥ –º–∞—Ä—à—Ä—É—Ç–æ–≤
ROUTES_PATH=src/config/routes.yaml

# –õ–æ–≥–∏
LOG_LEVEL=INFO

# aiogram polling
DROP_PENDING_UPDATES=true

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ MTProto: —Å–ª—É—à–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–∏ —á–∞—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
MT_ALLOWED_CHAT_IDS=-1003393646784
# –ø—Ä–∏–º–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö:
# MT_ALLOWED_CHAT_IDS=-1003393646784,-1002883955567
```

---

## 6) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã (routes.yaml)

`src/config/routes.yaml`:

```yaml
routes:
  - id: 'route_1'
    source:
      chat_id: -1003393646784
      thread_id: 27
    destinations:
      - chat_id: 1167359827
    filters:
      allow_bots: true
      allow_humans: true
      allow_channels: true
      allowed_content_types: ['text', 'photo', 'video', 'document', 'sticker']
```

### –ü–æ—è—Å–Ω–µ–Ω–∏—è

- `source.chat_id`

  - —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª: `-100...`
  - –ª–∏—á–∫–∞: `user_id` (–æ–±—ã—á–Ω–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π)

- `source.thread_id` ‚Äî ID —Ç–æ–ø–∏–∫–∞ (forum topic). –ï—Å–ª–∏ —É–±—Ä–∞—Ç—å `thread_id`, –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å **–≤—Å—é –≥—Ä—É–ø–ø—É**.
- `destinations.chat_id`

  - –ª–∏—á–∫–∞: `user_id` (—é–∑–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É `/start`)
  - –≥—Ä—É–ø–ø–∞/–∫–∞–Ω–∞–ª: `-100...`

- `destinations.thread_id` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–ø–∏–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.

---

## 7) –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∑–Ω–∞—Ç—å chat_id / thread_id

### 7.1 –ö–æ–º–∞–Ω–¥–∞ `/id`

–í –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ `/id` (aiogram).
–ü–∏—à–∏ –µ—ë **–≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ** (–≤ –Ω—É–∂–Ω–æ–π –≥—Ä—É–ø–ø–µ –∏ –≤ –Ω—É–∂–Ω–æ–º —Ç–æ–ø–∏–∫–µ):

```
/id@your_bot_username
```

–ë–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç:

```
chat_id=-100...
thread_id=...
user_id=...
```

üìå –í–∞–∂–Ω–æ: `thread_id` –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–∞–º, –≥–¥–µ —Ç–µ–±–µ –Ω—É–∂–µ–Ω —Ç–æ–ø–∏–∫. –í —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º–∞—Ö –±—É–¥—É—Ç —Ä–∞–∑–Ω—ã–µ thread_id.

### 7.2 –ü–æ –ª–æ–≥–∞–º MTProto

–í –ª–æ–≥–∞—Ö Telethon –±—É–¥–µ—Ç —Å—Ç—Ä–æ–∫–∞:

```
MT IN chat=-100... msg_id=... thread=27 ...
```

`thread=` ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å topic id, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ —Å—Ç–∞–≤–∏—Ç—å –≤ YAML.

---

## 8) –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

### 8.1 –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
docker compose up -d --build
```

### 8.2 –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
docker compose logs -f
```

### 8.3 –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
docker compose down
```

---

## 9) –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ª–æ–≥–∞—Ö, –∫–æ–≥–¥–∞ –≤—Å—ë –æ–∫

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:

- `MTProto listener started (filtered chats=[...])`
- `Run polling for bot @...`

–ü—Ä–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:

- `MT IN chat=... msg_id=... thread=... bot=... forum=...`
- `Forward try ...`
- `Forward OK ...` (–∏–ª–∏ `Forward FAIL ...`)

---

## 10) –ü—Ä–æ ‚ÄúUpdate is not handled‚Äù

–°–æ–æ–±—â–µ–Ω–∏–µ –≤–∏–¥–∞:

```
aiogram.event:Update ... is not handled
```

‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∞–ø–¥–µ–π—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (my_chat_member, —Ä–µ–∞–∫—Ü–∏–∏ –∏ —Ç.–¥.). –ù–∞ MTProto —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥ **–Ω–µ –≤–ª–∏—è–µ—Ç**.

–ï—Å–ª–∏ –±–µ—Å–∏—Ç ‚Äî –º–æ–∂–Ω–æ –ø–æ–Ω–∏–∑–∏—Ç—å –ª–æ–≥:

```python
import logging
logging.getLogger("aiogram.event").setLevel(logging.WARNING)
```

---

## 11) –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –ù–µ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ

- –ü—Ä–æ–≤–µ—Ä—å `.env` (token / api_id / api_hash / session)
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å `MTProto listener started`
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ MTProto —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏—Ç –Ω—É–∂–Ω—ã–π —á–∞—Ç: –µ—Å—Ç—å `MT IN chat=-100...`
- –í—Ä–µ–º–µ–Ω–Ω–æ —É–±–µ—Ä–∏ `thread_id` –∏–∑ `routes.yaml` –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –Ω–∞—á–Ω—ë—Ç —Å–ª–∞—Ç—å ‚Äú–≤—Å—é –≥—Ä—É–ø–ø—É‚Äù

### ‚ùå `Bad Request: chat not found`

- destination chat_id –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –±–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- –µ—Å–ª–∏ destination ‚Äî –ª–∏—á–∫–∞: —é–∑–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É `/start`

### ‚ùå `Bad Request: message to forward not found`

–≠—Ç–æ —á–∞—Å—Ç—ã–π –∫–µ–π—Å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π **–¥—Ä—É–≥–∏—Ö –±–æ—Ç–æ–≤**: Bot API –Ω–µ –º–æ–∂–µ—Ç —Ñ–æ—Ä–≤–∞—Ä–¥–Ω—É—Ç—å –∏—Ö –∫–∞–∫ ‚Äúforward‚Äù.

–†–µ—à–µ–Ω–∏–µ: –≤–∫–ª—é—á–∏—Ç—å fallback ‚Äúrepost‚Äù (–ø—Ä–æ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ `send_message`, –µ—Å–ª–∏ forward –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª).

---

## 12) –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ MTProto —á—Ç–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–º —á–∞—Ç–æ–º (env)

–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è:

```env
MT_ALLOWED_CHAT_IDS=-1003393646784
```

- –æ–¥–∏–Ω —á–∞—Ç: `-100...`
- –Ω–µ—Å–∫–æ–ª—å–∫–æ: —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º:

```env
MT_ALLOWED_CHAT_IDS=
```

MTProto –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å **–≤—Å–µ** —á–∞—Ç—ã –∞–∫–∫–∞—É–Ω—Ç–∞.

---

## 13) –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- `TG_USER_SESSION` ‚Äî –∫–ª—é—á –æ—Ç Telegram –∞–∫–∫–∞—É–Ω—Ç–∞ (–∫–∞–∫ –ø–∞—Ä–æ–ª—å)
- –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π ‚Äú—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π‚Äù –∞–∫–∫–∞—É–Ω—Ç –ø–æ–¥ MTProto

## License

This project is licensed under the MIT License ‚Äî see the `LICENSE` file for details.
